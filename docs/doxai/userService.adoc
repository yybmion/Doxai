```asciidoc
= UserService - Technical Documentation

== PR Information

* PR Number: 23
* Author: yybmion
* Created Date: 2025-05-26
* Last Modified: 2025-05-26 by yybmion

== File Information

* Filename: examples/service/userService.js
* Language: JavaScript

== Overview

The `UserService` class handles all user-related business logic and data operations.  It interacts with a `UserRepository` to manage user data persistence, uses `bcrypt` for password hashing, `jsonwebtoken` for JWT token generation, and `emailService` for sending emails.  The `logger` is used for logging purposes.  The `ValidationError` and `NotFoundError` are custom error classes (assumed to be defined elsewhere).  The JWT secret is retrieved from environment variables, defaulting to 'default-secret' if not found.  The salt rounds for password hashing are set to 10.


== Class: UserService

=== Constructor

`constructor()`

Initializes the `userRepository` instance and sets `saltRounds` and `jwtSecret`.

=== Methods

==== `createUser(userData)`

* Creates a new user.
* Parameters:
    * `userData`: An object containing user data (`email`, `password`, `name`, optional `role`).
* Returns: A `Promise` resolving to the created user object (without the password).
* Throws: `ValidationError` if user data is invalid.
* Notes:  Validates input data, checks for existing users, hashes the password using bcrypt, creates the user in the database, sends a welcome email (using `sendWelcomeEmail`), and logs the creation event.  Error handling is included.

==== `authenticateUser(email, password)`

* Authenticates a user and generates a JWT token.
* Parameters:
    * `email`: User email.
    * `password`: User password.
* Returns: A `Promise` resolving to an object containing the user (without password) and the JWT token.
* Throws: `ValidationError` if credentials are invalid or the account is deactivated.
* Notes: Retrieves the user from the database, verifies the password using bcrypt, generates a JWT token using `generateToken`, updates the user's last login timestamp, and logs the authentication event.

==== `getUserById(userId)`

* Retrieves a user by ID.
* Parameters:
    * `userId`: User ID.
* Returns: A `Promise` resolving to the user object (without password).
* Throws: `NotFoundError` if the user is not found.

==== `updateUserProfile(userId, updateData)`

* Updates a user's profile.
* Parameters:
    * `userId`: User ID.
    * `updateData`: An object containing the data to update.
* Returns: A `Promise` resolving to the updated user object (without password).
* Throws: `NotFoundError` if the user is not found.
* Notes:  Removes sensitive fields (`password`, `email`, `role`, `isActive`) from `updateData` before updating.

==== `changePassword(userId, currentPassword, newPassword)`

* Changes a user's password.
* Parameters:
    * `userId`: User ID.
    * `currentPassword`: Current password.
    * `newPassword`: New password.
* Returns: A `Promise` resolving to a boolean indicating success.
* Throws: `NotFoundError` if the user is not found, `ValidationError` if the current password is incorrect.

==== `getAllUsers(options)`

* Retrieves all users with pagination.
* Parameters:
    * `options`: An object containing pagination options (`page`, `limit`, `sortBy`, `sortOrder`).
* Returns: A `Promise` resolving to a paginated users result.
* Notes:  Removes passwords from all returned users.

==== `deleteUser(userId)`

* Deletes a user (soft delete).
* Parameters:
    * `userId`: User ID.
* Returns: A `Promise` resolving to a boolean indicating success.
* Throws: `NotFoundError` if the user is not found.

==== `searchUsers(query)`

* Searches users by name or email.
* Parameters:
    * `query`: Search query.
* Returns: A `Promise` resolving to an array of matching users.
* Notes: Returns an empty array if the query is too short.  Removes passwords from all returned users.


=== Private Helper Methods

==== `validateUserData(userData)`

* Validates user data.  Throws `ValidationError` for invalid data.  Details of validation are included in the code.

==== `isValidEmail(email)`

* Checks if an email address is valid using a regular expression.

==== `generateToken(user)`

* Generates a JWT token for a given user.

==== `sendWelcomeEmail(user)`

* Sends a welcome email to a user.  Catches errors during email sending but doesn't throw them. Logs errors.


== Dependencies

* `bcrypt`: For password hashing.
* `jsonwebtoken`: For JWT token generation.
* `UserRepository`: For database interactions.
* `ValidationError`, `NotFoundError`: Custom error classes.
* `sendEmail`: Email sending utility function.
* `logger`: Logging utility.


== Unclear Aspects

* The exact implementation of `UserRepository`, `ValidationError`, `NotFoundError`, and `sendEmail` is unknown and needs to be referenced separately.  The structure of the returned data from `UserRepository` methods is also assumed.
* The `welcome` email template is assumed to exist and be accessible by `sendEmail`.

```
